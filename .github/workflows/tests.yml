#
# File: tests.yml
# Description: Run unit and feature tests on pull requests and pushes to main
# Copyright: 2026 Cloudmanic Labs, LLC
# Date: 2026-01-21
#

name: Tests

# -----------------------------------------------------------------------------
# Workflow Triggers
# -----------------------------------------------------------------------------
# This workflow runs on:
# - All pull requests targeting the main branch
# - All pushes directly to the main branch (for merge commits)
# -----------------------------------------------------------------------------
on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  tests:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------------------------------
      # Step 1: Checkout the repository code
      # -------------------------------------------------------------------------
      # This pulls the latest code from the branch being tested so we can
      # run the test suite against it.
      # -------------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -------------------------------------------------------------------------
      # Step 2: Set up PHP environment
      # -------------------------------------------------------------------------
      # We use PHP 8.4 to match the project's composer.lock requirements.
      # Extensions enabled:
      # - dom, curl, libxml, mbstring: Required by Laravel
      # - zip: Required by Composer for package installation
      # - pcntl: Required for parallel testing
      # - pdo, sqlite, pdo_sqlite: Required for SQLite database testing
      # - bcmath: Required for precise numeric operations
      # - intl: Required for internationalization features
      # -------------------------------------------------------------------------
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, intl
          coverage: none

      # -------------------------------------------------------------------------
      # Step 3: Set up Node.js environment
      # -------------------------------------------------------------------------
      # Node.js is required to build front-end assets with Vite.
      # Using Node 20 LTS for stability.
      # -------------------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # -------------------------------------------------------------------------
      # Step 4: Cache Composer dependencies
      # -------------------------------------------------------------------------
      # Caching significantly speeds up subsequent workflow runs by avoiding
      # re-downloading unchanged dependencies. The cache key is based on the
      # composer.lock file hash, so it invalidates when dependencies change.
      # -------------------------------------------------------------------------
      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      # -------------------------------------------------------------------------
      # Step 5: Install Composer dependencies
      # -------------------------------------------------------------------------
      # Using --prefer-dist for faster downloads (pre-built archives)
      # Using --no-progress to reduce log noise in CI
      # Using --no-interaction to prevent prompts that would hang the workflow
      # -------------------------------------------------------------------------
      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      # -------------------------------------------------------------------------
      # Step 6: Install NPM dependencies
      # -------------------------------------------------------------------------
      # Using npm ci for faster, more reliable installs in CI environments.
      # npm ci uses the exact versions from package-lock.json.
      # -------------------------------------------------------------------------
      - name: Install NPM dependencies
        run: npm ci

      # -------------------------------------------------------------------------
      # Step 7: Build front-end assets
      # -------------------------------------------------------------------------
      # Vite builds the CSS and JavaScript assets required for the application.
      # This ensures tests that render views have access to compiled assets.
      # -------------------------------------------------------------------------
      - name: Build assets
        run: npm run build

      # -------------------------------------------------------------------------
      # Step 8: Prepare Laravel environment
      # -------------------------------------------------------------------------
      # Copy the example environment file and generate a fresh application key.
      # The CITY_KEY is set to 'sherwood' to match the default configuration.
      # -------------------------------------------------------------------------
      - name: Copy environment file
        run: cp .env.example .env

      - name: Generate application key
        run: php artisan key:generate

      # -------------------------------------------------------------------------
      # Step 9: Set up SQLite database for testing
      # -------------------------------------------------------------------------
      # Create an empty SQLite database file. The tests use in-memory SQLite
      # (configured in phpunit.xml), but having the file present prevents
      # any potential issues with database path resolution.
      # -------------------------------------------------------------------------
      - name: Create SQLite database
        run: touch database/database.sqlite

      # -------------------------------------------------------------------------
      # Step 10: Run database migrations
      # -------------------------------------------------------------------------
      # Run migrations to set up the database schema. While tests use in-memory
      # SQLite, this ensures the schema is valid and migrations work correctly.
      # -------------------------------------------------------------------------
      - name: Run migrations
        run: php artisan migrate --force

      # -------------------------------------------------------------------------
      # Step 11: Run the test suite
      # -------------------------------------------------------------------------
      # Execute all unit and feature tests. This is the primary quality gate
      # that must pass for PRs to be mergeable (when branch protection is enabled).
      # -------------------------------------------------------------------------
      - name: Run tests
        run: php artisan test

  # ---------------------------------------------------------------------------
  # Code Style Check Job
  # ---------------------------------------------------------------------------
  # This job runs Laravel Pint to check code formatting. It runs in parallel
  # with the tests job for faster feedback. This job does NOT fail the workflow
  # if style issues are found - it only reports them for informational purposes.
  # ---------------------------------------------------------------------------
  code-style:
    name: Check Code Style
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------------------------------
      # Step 1: Checkout the repository code
      # -------------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -------------------------------------------------------------------------
      # Step 2: Set up PHP environment
      # -------------------------------------------------------------------------
      # Only need PHP for running Pint - no extensions required.
      # Using PHP 8.4 to match the project's composer.lock requirements.
      # -------------------------------------------------------------------------
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          coverage: none

      # -------------------------------------------------------------------------
      # Step 3: Cache Composer dependencies
      # -------------------------------------------------------------------------
      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      # -------------------------------------------------------------------------
      # Step 4: Install Composer dependencies
      # -------------------------------------------------------------------------
      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      # -------------------------------------------------------------------------
      # Step 5: Run Laravel Pint (code style checker)
      # -------------------------------------------------------------------------
      # The --test flag makes Pint report issues without modifying files.
      # Using 'continue-on-error: true' so style issues don't fail the workflow.
      # This provides visibility into code style without blocking merges.
      # -------------------------------------------------------------------------
      - name: Run Laravel Pint
        run: ./vendor/bin/pint --test
        continue-on-error: true
